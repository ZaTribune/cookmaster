<div xmlns:th="http://www.thymeleaf.org">
    <!--specify the encoding type to allow uploading images via html -->
    <form th:fragment="AddRecipeFragment"
          th:object="${recipe}"
          th:action="@{/updateOrSaveRecipe}"
          id="createRecipeForm"
          method="POST"
          class="justify-content-center">
        <!-- to fix ingredient.unitMeasure options removed when validation errors happen-->
        <div class="d-none" >
            <input type="hidden" th:each="unit,stat:*{unitMeasures}"
                   th:name="'unitMeasures['+__${stat.index}__+'].id'"
                   th:value="*{unitMeasures[__${stat.index}__].id}">
            <input type="hidden" th:each="unit,stat:*{unitMeasures}"
                   th:name="'unitMeasures['+__${stat.index}__+'].description'"
                   th:value="*{unitMeasures[__${stat.index}__].description}">
        </div>
        <div th:if="${#fields.hasErrors('*')}" class="alert alert-danger m-0">
            <p>Please, correct errors below.</p>
        </div>
        <div class="card">
            <input type="hidden" th:field="*{id}">
            <div class="card-header"><h1 th:text="#{mainInformation}">Main Information</h1></div>
            <div class="card-body container-fluid">
                <div class="row">
                    <div class="col container-fluid">
                        <div class="row position-relative">
                            <label class="m-1"><span th:text="#{recipe.title}"></span>
                                <input type="text" class="form-control w-50" id="inputTitle" placeholder="Recipe Name"
                                       th:field="*{title}">
                            </label>
                            <div class="invalid-feedback d-inline-block" th:if="${#fields.hasErrors('title')}">
                                <ul class="m-0">
                                    <li th:each="err:${#fields.errors('title')}" th:text="${err}"></li>
                                </ul>
                            </div>
                        </div>
                        <div class="row">
                            <label class="m-1"><span th:text="#{recipe.prepTime}"></span>
                                <input type="number" class="form-control w-25" id="inputPrepTime"
                                       placeholder="minutes"
                                       th:field="*{prepTime}">
                            </label>
                            <div class="invalid-feedback d-inline-block" th:if="${#fields.hasErrors('prepTime')}">
                                <ul class="m-0">
                                    <li th:each="err:${#fields.errors('prepTime')}" th:text="${err}"></li>
                                </ul>
                            </div>
                        </div>
                        <div class="row">
                            <label class="m-1"><span th:text="#{recipe.cookTime}"></span>
                                <input type="number" class="form-control w-25" id="inputCockTime"
                                       placeholder="minutes"
                                       th:field="*{cookTime}">
                            </label>
                            <div class="invalid-feedback d-inline-block" th:if="${#fields.hasErrors('cookTime')}">
                                <ul class="m-0">
                                    <li th:each="err:${#fields.errors('cookTime')}" th:text="${err}"></li>
                                </ul>
                            </div>
                        </div>
                        <div class="row">
                            <label class="m-1"><span th:text="#{recipe.difficulty}"></span>
                                <select class="custom-select mr-sm-2" id="inlineFormCustomSelect"
                                        th:field="*{difficulty}" required>
                                    <option selected value="EASY" th:text="#{easy}"></option>
                                    <option value="MODERATE" th:text="#{moderate}"></option>
                                    <option value="HARD" th:text="#{hard}"></option>
                                </select>
                            </label>
                        </div>
                        <div class="row">
                            <label class="m-1"><span th:text="#{recipe.servings}"></span>
                                <input type="text" class="form-control w-25" id="inputServings"
                                       placeholder="times"
                                       th:field="*{servings}">
                            </label>
                            <div class="invalid-feedback d-inline-block" th:if="${#fields.hasErrors('servings')}">
                                <ul class="m-0">
                                    <li th:each="err:${#fields.errors('servings')}" th:text="${err}"></li>
                                </ul>
                            </div>
                        </div>
                        <div class="row m-1">
                            <div class="col-12 fw-bold p-0">
                                <label class="m-1"><span th:text="#{categories}"></span>
                                    <input type="text" class="form-control w-100" id="inputCategory"
                                                         list="categoriesListContainer"
                                                         onkeyup="$('#categoriesListContainer').load('/listCategories'+'?s='+this.value)">
                                </label>
                                <div id="categoriesListContainer" class="autocomplete-items list-group w-25">
                                </div>
                            </div>
                            <div id="selectedCategories" class="col-lg-8 col-md-8 p-0 list-group mt-1">
                                <a class="list-group-item d-flex justify-content-between p-1 align-items-center text-dark"
                                   xmlns:th="http://www.thymeleaf.org"
                                   th:each="category, stat : *{categories}"
                                   th:attr="data-category-id=${category.id},data-category-description=${category.description}">
                                    <i th:text="${category.description}"></i>
                                    <button class='btn btn-secondary' onclick='this.closest("a").remove()'><i
                                            class='fa fa-trash p-1'></i></button>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col text-center">
                        <input type="file" accept="image/*" class="file"
                               onchange="getBase64($('#image'),$('#imgPreview'),this.files[0])"/>
                        <input type="hidden" th:field="*{image}">
                        <p th:switch="${recipe.image}">
                            <img class="img-fluid"
                                 th:case="null"
                                 th:id="imgPreview"
                                 th:src="@{/images/camera.svg}"
                                 th:width="300"
                                 th:height="300" alt="image">
                            <img class="img-fluid"
                                 th:case="*"
                                 th:id="imgPreview"
                                 th:src="@{${recipe.image}}"
                                 th:width="300"
                                 th:height="300" alt="image">
                            <!-- th:src="@{'data:image/png;base64,'+${recipe.image}}" -->
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header"><h1 th:text="#{ingredients}"></h1></div>
            <div class="card-body table-responsive">
                <table id="ingredientsTable" class="table table-sm">
                    <tr>
                        <th>*</th>
                        <th th:text="#{amount}"></th>
                        <th th:text="#{unit}"></th>
                        <th th:text="#{description}"></th>
                    </tr>
                    <tr th:each="ing,ingStat :*{ingredients}" class="ingredient-row">
                        <td class="p-0" style="vertical-align: middle">
                            <input class="form-check-input me-1" type="checkbox"
                                   th:value="*{ingredients[__${ingStat.index}__].id}" aria-label="">
                            <input type="hidden" class="ingredient-id"
                                   th:field="*{ingredients[__${ingStat.index}__].id}">
                            <!-- Required!! put the index.id  not the eng.id-->
                        </td>
                        <td class="p-0"><input class="ingredient-amount"
                                               th:field="*{ingredients[__${ingStat.index}__].amount}"
                                               th:value="${ing.amount}" aria-label=""></td>
                        <td class="p-0" style="vertical-align: middle">
                            <select class="ingredient-unitMeasure-id custom-select mr-sm-2" aria-label=""
                                    th:field="*{ingredients[__${ingStat.index}__].unitMeasure.id}"
                                    onchange="selectUnitMeasure(this,this.parentElement.lastElementChild)" required><!-- to pass the hidden field-->
                                <!--       REMEMBER: compare using the ID -->
                                <option
                                        th:each="unit,unitStat:*{unitMeasures}"
                                        th:value="${unit.id}" th:text="${unit.description}"
                                        th:selected="(${ing.unitMeasure.id} == ${unit.id})">
                                </option>
                            </select>
                            <input type="hidden" class="ingredient-unitMeasure-description"
                                   th:name="'ingredients['+__${ingStat.index}__+'].unitMeasure.description'">
                        </td>
                        <td class="p-0">
                            <input class="ingredient-description"
                                   th:field="*{ingredients[__${ingStat.index}__].description}"
                                   type="text" th:value="${ing.description}" aria-label="">
                        </td>
                    </tr>
                </table>
                <div>
                    <button class="btn btn-success"
                            type="button"
                            onclick="insertIngredient()">
                        <i class="fa fa-plus d-table-cell"></i>
                    </button>
                    <button class="btn btn-warning"
                            type="button"
                            onclick='deleteTableRow($("#ingredientsTable"))'>
                        <i class="fa fa-minus d-table-cell"></i>
                    </button>
                </div>
            </div><!--END of ingredients edit ares-->
        </div>
        <div class="card">
            <div class="card-header"><h1 th:text="#{recipe.directions}"></h1></div>
            <div class="card-body">
                    <textarea id="textareaDirections" class="form-control" onload="resizeTextarea(this.id)"
                              aria-label=""
                              onkeyup="resizeTextarea(this.id)" th:field="*{directions}"></textarea>
                <div class="invalid-feedback d-inline-block" th:if="${#fields.hasErrors('directions')}">
                    <ul class="m-0">
                        <li th:each="err:${#fields.errors('directions')}" th:text="${err}"></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header"><h1 th:text="#{notes}"></h1></div>
            <div class="card-body">
                <input type="hidden" th:field="*{notes.id}">
                    <textarea id="textareaNotes" class="form-control" onload="resizeTextarea(this.id)" aria-label=""
                              onkeyup="resizeTextarea(this.id)" th:field="*{notes.description}"></textarea>
                <div class="invalid-feedback d-inline-block" th:if="${#fields.hasErrors('notes.description')}">
                    <ul class="m-0">
                        <li th:each="err:${#fields.errors('notes.description ')}" th:text="${err}"></li>
                    </ul>
                </div>
            </div>
        </div>
    </form>
    <div class="card align-items-center">
        <button th:attr="data-recipe=${recipe.id}" id="btnSubmitRecipe"
                class="btn btn-primary w-25 m-2" th:height="50" type="submit"
                onclick="sendData(this.getAttribute('data-recipe'))" th:text="#{save}">
            Save
        </button>
    </div>

    <script th:inline="javascript">
        $(document).ready(function () {
            resizeTextarea('textareaNotes');
            resizeTextarea('textareaDirections')
        });

        function getBase64(input, preview, file) {
            let reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function () {
                input.attr('value', reader.result);
                preview.attr('src', reader.result);
            };
            reader.onerror = function (error) {
                console.log('Error: ', error);
            };
        }

        function deleteTableRow(table) {
            $('#' + table[0].id + ' tbody tr td input:checkbox:checked').each(function (index, element) {
                this.closest("tr").remove();
            });
            //reassign names --> example if we deleted #4
            //ingredients[3].id: 26
            //ingredients[3].amount:
            //ingredients[3].unitMeasure.id: 3
            //ingredients[3].description:
            //ingredients[5].id: 13 .........

            $('.' + 'ingredient-id').each(function (index, element) {
                element.setAttribute("id", 'ingredients' + index + '.id');
                element.setAttribute("name", 'ingredients[' + index + '].id');
            })
            $('.' + 'ingredient-amount').each(function (index, element) {
                element.setAttribute("name", 'ingredients[' + index + '].amount');
                element.setAttribute("id", 'ingredients' + index + '.amount');
            })
            $('.' + 'ingredient-unitMeasure-id').each(function (index, element) {
                element.setAttribute("name", 'ingredients[' + index + '].unitMeasure.id');
                element.setAttribute("id", 'ingredients' + index + '.unitMeasure.id');
            })
            $('.' + 'ingredient-unitMeasure-description').each(function (index, element) {
                element.setAttribute("name", 'ingredients[' + index + '].unitMeasure.description');
                element.setAttribute("id", 'ingredients' + index + '.unitMeasure.description');
            })
            $('.' + 'ingredient-description').each(function (index, element) {
                element.setAttribute("name", 'ingredients[' + index + '].description');
                element.setAttribute("id", 'ingredients' + index + '.description');
            })
        }

        function insertCategory(parentId, item){
            let invalid = false;
            let parent=document.getElementById(parentId);
            Array.from(parent.children).forEach((child,index)=>{
                if (item.getAttribute("data-category-id")===child.getAttribute("data-category-id")){
                    invalid=true;
                    return false;
                }
            });
            if (invalid===true)
                return;

            item.setAttribute('class','list-group-item d-flex justify-content-between p-1 align-items-center text-dark');
            item.setAttribute('onclick','');
            //alert("parentID:"+parentId+"\nitemId:"+itemId+"\nitemText"+itemText);
            let btnDelete=document.createElement('button');
            item.appendChild(btnDelete);
            //must have a parent before setting outerHTML
            btnDelete.outerHTML="<button class='btn btn-secondary' onclick='this.closest(\"a\").remove()'><i class='fa fa-trash p-1'></i></button>";
            parent.appendChild(item);
        }

        function insertIngredient() {
            /*<![CDATA[*/
            let unitMeasures = /*[[${recipe.unitMeasures}]]*/'default';
            //returned object is like: [object Object],[object Object],[object Object]
            /*]]>*/
            let select = document.createElement("select");// Create with DOM
            for (let i = 0; i < unitMeasures.length; i++) {
                select.innerHTML += '<option value=' + unitMeasures[i]["id"] + '>' + unitMeasures[i]["description"] + '</option>';
            }

            let table = $('#ingredientsTable tbody');
            //the array counts from 0 But!!! there's a header
            //we need it to insert on the end
            let rowCount = $('#ingredientsTable tr').length - 1;
            select.setAttribute('class', "custom-select mr-sm-2")
            select.setAttribute('name', "ingredients[" + rowCount + "].unitMeasure.id")
            select.setAttribute('value', "ingredients[" + rowCount + "].unitMeasure.id")
            select.setAttribute('onchange',"selectUnitMeasure(this,this.parentElement.lastElementChild)")
            table.append('<tr>' +
                '<td class="p-0" style="vertical-align: middle"><input class="form-check-input me-1" type="checkbox">' +
                '<input type="hidden" name="ingredients[' + rowCount + '].id">' +
                '</td>' +
                '<td class="p-0"><input name="ingredients[' + rowCount + '].amount"></td>' +
                '<td class="p-0" style="vertical-align: middle">' +
                select.outerHTML +
                '<input type="hidden" class="ingredient-unitMeasure-description" '+
                'name="ingredients['+rowCount+'].unitMeasure.description">'+
                '</td>' +
                '<td class="p-0"><input name="ingredients[' + rowCount + '].description" ' +
                'type="text">' +
                '</td>' +
                '</tr>')
        }

        function selectUnitMeasure(select,unitMeasureDescriptionField) {
            unitMeasureDescriptionField.setAttribute('value',select.options[select.selectedIndex].text)
        }

        function closeAllLists() {
            $('#categoriesListContainer').empty()
        }

        document.addEventListener("click", function (e) {
            closeAllLists(e.target);
        });

        function sendData(recipeId) {
            //let myFile = $('#image').prop('files');
            //console.log(typeof myFile);

            let selectedCategories = $('#selectedCategories');
            selectedCategories.children('a').each(function (index, element) {
                $('<input />').attr('type', 'hidden')
                    .attr('name', 'categories[' + index + '].id')
                    .attr('value', element.getAttribute('data-category-id'))
                    .appendTo('#createRecipeForm');
                $('<input />').attr('type', 'hidden')
                    .attr('name', 'categories[' + index + '].description')
                    .attr('value', element.getAttribute('data-category-description'))
                    .appendTo('#createRecipeForm');
            });
            /*<![CDATA[*/
            let unitMeasures = /*[[${recipe.unitMeasures}]]*/'default';
            //returned object is like: [object Object],[object Object],[object Object]
            /*]]>*/
            $('.' + 'ingredient-unitMeasure-description').each(function (index, element) {
                element.setAttribute("value", unitMeasures[element.previousElementSibling.selectedIndex]["description"]);
            })
            $.ajax(
                {
                    //don't add contentType: false,processData: false,
                    type: "POST",
                    data: $("#createRecipeForm").serialize(),
                    cache: false,
                    url: "/updateOrSaveRecipe",
                    success: function (data) {
                        $('#recipeTabContent').html(data);
                    },
                    error: function (data) {
                        alert("Error - Data not saved");
                    }
                });
        }
    </script>
</div>



